# Установка Joomla

Этот плэйбук Ansible автоматизирует процесс установки и базовой настройки Joomla на целевых серверах. Он включает установку и настройку Apache, PHP, MariaDB, а также загрузку и распаковку файлов Joomla.

## Требования

Для успешного выполнения этого плэйбука убедитесь, что ваши целевые серверы соответствуют следующим требованиям:

- **Операционные системы:**

  - Семейство Debian (например, Ubuntu, Debian). Протестировано на:
  - Семейство RedHat (например, CentOS Streanm, Almalinux, Rocky Linux). Протестировано на:
    - **Almalinux:** `8`, `9`, `10`

- **Ansible:** Установлен на управляющей машине (версия 2.9 или выше рекомендуется).

- **Доступ:** SSH доступ к целевым серверам с возможностью выполнения команд с правами `sudo` без запроса пароля ( рекомендуется настройка `sudoers` ).

- **Подключение к интернету:** Целевые серверы должны иметь доступ к репозиториям пакетов и сайту загрузки Joomla.

## СТруктура проекта

Типичная структура директорий для этого плэйбука может выглядеть так:

```text
├── playbook.yaml
├── all.yaml
├── roles/
│   ├── update_os/
│   │   └── tasks/
│   │       └── main.yaml
│   ├── apache/
│   │   └── tasks/
│   │       └── main.yaml
│   ├── php/
│   │   └── tasks/
│   │       └── main.yaml
│   ├── mariadb/
│   │   └── tasks/
│   │       └── main.yaml
│   └── <другие роли, если есть>
└── templates/
    └── joomla.conf.j2
```

- `playbook.yaml`: Главный файл плейбука.
- `all.yaml`: Файл переменных, применяемых ко всем хостам.
- `roles/`: Директория, содержащая используемые роли.
- `templates/`: Директория для шаблонов конфигурационных файлов (например, для Apache).

## Переменные

Вы можете настроить поведение плейбука, изменяя переменные в файле `all.yaml` или определяя их в `group_vars/host_vars`. Ниже перечислены основные переменные:

- `php_module`: Список модулей PHP, которые будут установлены. Определен в `all.yaml` с учетом специфики ОС.
  - *Пример:* `['php-mysql', 'php-gd', 'php-curl']`.
- `php_modules_debian`: (Используется внутренне) Дополнительные модули PHP, специфичные для определенных ОС (в текущей версии для семейства Debian).
- `db_name`: Имя базы данных, которая будет создана в Joomla.
  - *Пример*: `joomla_db`
- `db_user`: Имя пользователя базы данных, который будет создан для Joomla и получит доступ к `db_name`.
  - *Пример:* `joomla_user`
- `joomla_version`: Версия Joomla для скачивания и установки.
  - *Пример*: 5-2-3
- `owner_apache`: Пользователь ОС, под которым работает веб-сервер Apache и который будет владельцем файлов Joomla. Определяется автоматически в зависимости от семейства ОС (`www-data` для Debian-подобных, `apache` для RedHat-подобных).
- `apache_service`: Имя службы Apache в системе. Определяется автоматически в зависимости от семейства ОС ( `apache2` для Debian-подобных, `httpd` - для RedHat-подобных).
- `work_dir_apache`: Полный путь к конфигурационному файлу виртуального хоста Apache для Joomla. Определяется автоматически в зависимости от семейства ОС.

## Запуск плейбука

Перед запуском убедитесь, что у вас настроен инвентарь Ansible ( файл `hosts` или аналогичный ) с целевыми серверами.

Для запуска плейбука выполните следующую команду из корневой директории проекта:

```bash
ansible-playbook playbook.yaml
```

Если вам нужно передать переменные напрямую или переопределить значения из `all.yaml`, вы можете использовать опцию `--extra-vars`или `-e`:

```bash
ansible-playbook playbook.yaml -e "db_name=custom_db db_user=cutom_user"
```

## Роли

Плейбук использует следующие роли для установки и настройки компонентов:

- `update_os`: обновляет пакеты операционной системы. **Внимание**: эта роль может привести к перезагрузке сервера, если это необходимо после обновления ядра или других критических пакетов. Если вам не требуется обновление ОС, вы можете закомментировать эту роль в `playbook.yaml`.
- `apache`: устанавливает и настраивает веб-сервер Apache.
- `php`: устанавливает PHP и необходимые модули.
- `mariadb`: устанавливает и настраивает сервер базы данных MariaDB, создает базу данных и пользователя Joomla.

## Дальнейшие шаги

После успешного выполнения плейбука:

1. Перейдите в веб-браузере по доменному имени или IP-адресу вашего сервера, указанному в конфигурации виртуального хоста.

2. Вы должны увидеть страницу установки Joomla. Следуйте инструкциям на экране для завершения установки, используя данные базы данных, созданные плейбуком (`db_name`, `db_user` и пароль, который должен быть определен в переменных или передан в роль `mariadb`).

3. После завершения установки через веб-интерфейс удалите или переименуйте директорию `installation` в корневой директории Joomla ( `/var/www/html/joomla/installation` ) для безопасности.
